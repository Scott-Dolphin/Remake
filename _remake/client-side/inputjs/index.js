import { initRemoveAndHideEventListeners } from "./removeAndHideEventListeners";
import initEventsForUpdatingData from "./eventsForUpdatingData";
import initSaveEventListener from "./saveEventListener";
import optionsData from "./optionsData";
import {
  onSave,
  onFileUpload,
  onFileUploadProgress,
  onAddItem,
  onRemoveItem,
  onSync,
} from "./callbacks";
import { initSaveFunctions, callSaveFunction, saveData } from "./onSave";
import initEditableAttribute from "./editableAttribute";
import initAddingItemEventListener from "./addingItemEventListener";
import initSortableElements from "./sortableElements";
import initAutoGeneratedComponents from "./autoGeneratedComponents";
import initEventListenerHelpers from "./eventListenerHelpers";
import runWatchFunctions from "./runWatchFunctions";
import processShowIfAttributes from "../common/show-if";

const merge = require("lodash/merge");

function init(options) {
  // deep merge user options into default remake options
  merge(optionsData, options);

  if (optionsData.sortable) {
    // can be called more than once without initializing the same elements twice
    initSortableElements();
  }

  if (optionsData.alreadyInitialized) {
    if (!document.getElementById("remake__auto-generated")) {
      // if the auto-generated components were removed somehow, re-add them
      initAutoGeneratedComponents();
    }

    // if already initialized, don't initialize anything else (e.g. event handlers)
    return;
  }

  // first because they affect might affect visibility of some elements
  processShowIfAttributes();
  runWatchFunctions();

  // this creates element, so it should be loaded before most other scripts
  initAutoGeneratedComponents();

  initSaveFunctions();
  initRemoveAndHideEventListeners();
  initEventsForUpdatingData();
  initSaveEventListener();
  initEditableAttribute();
  initAddingItemEventListener();
  initEventListenerHelpers();

  onAddItem(function () {
    runWatchFunctions();
    processShowIfAttributes();
  });

  onRemoveItem(function () {
    runWatchFunctions();
  });

  // must be at the end in case one of these init scripts checks for it
  optionsData.alreadyInitialized = true;
}

export {
  init,
  callSaveFunction,
  onSave,
  onFileUpload,
  onFileUploadProgress,
  onAddItem,
  onRemoveItem,
  runWatchFunctions,
  onSync,
  saveData,
};
